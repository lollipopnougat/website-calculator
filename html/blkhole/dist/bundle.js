(()=>{"use strict";class e{constructor(e){this.program=null,this.uniformLocations=new Map,this.gl=e}async load(e,t){try{const[r,i]=await Promise.all([fetch(e).then((e=>e.text())),fetch(t).then((e=>e.text()))]);return this.compile(r,i)}catch(e){return console.error("加载着色器失败:",e),!1}}compile(e,t){const r=this.gl,i=this.createShader(r.VERTEX_SHADER,e),s=this.createShader(r.FRAGMENT_SHADER,t);if(!i||!s)return!1;const a=r.createProgram();return a?(r.attachShader(a,i),r.attachShader(a,s),r.linkProgram(a),r.getProgramParameter(a,r.LINK_STATUS)?(this.program=a,r.deleteShader(i),r.deleteShader(s),!0):(console.error("链接程序失败:",r.getProgramInfoLog(a)),r.deleteProgram(a),!1)):(console.error("创建着色器程序失败"),!1)}createShader(e,t){const r=this.gl,i=r.createShader(e);return i?(r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)?i:(console.error(`编译${e===r.VERTEX_SHADER?"顶点":"片元"}着色器失败:`,r.getShaderInfoLog(i)),r.deleteShader(i),null)):(console.error("创建着色器失败"),null)}use(){this.program&&this.gl.useProgram(this.program)}getUniformLocation(e){if(!this.program)return null;if(this.uniformLocations.has(e))return this.uniformLocations.get(e)||null;const t=this.gl.getUniformLocation(this.program,e);return t&&this.uniformLocations.set(e,t),t}setUniform1f(e,t){const r=this.getUniformLocation(e);r&&this.gl.uniform1f(r,t)}setUniform2f(e,t,r){const i=this.getUniformLocation(e);i&&this.gl.uniform2f(i,t,r)}setUniform3f(e,t,r,i){const s=this.getUniformLocation(e);s&&this.gl.uniform3f(s,t,r,i)}setUniform1i(e,t){const r=this.getUniformLocation(e);r&&this.gl.uniform1i(r,t)}}class t{constructor(e){this.texture=null,this.width=0,this.height=0,this.gl=e}async loadFromUrl(e){return new Promise((t=>{const r=new Image;r.onload=()=>{this.width=r.width,this.height=r.height;const e=this.loadFromImage(r);t(e)},r.onerror=()=>{console.error(`加载纹理失败: ${e}`),t(!1)},r.src=e}))}loadFromImage(e){const t=this.gl,r=t.createTexture();return r?(t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),this.texture=r,!0):(console.error("创建纹理失败"),!1)}createEmptyTexture(e,t,r=!1){const i=this.gl,s=i.createTexture();if(!s)return console.error("创建纹理失败"),!1;this.width=e,this.height=t,i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);const a=i.RGBA,o=i.RGBA,h=r?i.FLOAT:i.UNSIGNED_BYTE;return i.texImage2D(i.TEXTURE_2D,0,a,e,t,0,o,h,null),this.texture=s,!0}async loadCubemap(e){if(6!==e.length)return console.error("立方体贴图需要6个面的图像"),!1;const t=this.gl,r=t.createTexture();if(!r)return console.error("创建立方体贴图失败"),!1;t.bindTexture(t.TEXTURE_CUBE_MAP,r),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR);const i=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];try{const s=e.map(((e,s)=>new Promise(((a,o)=>{const h=new Image;h.onload=()=>{t.bindTexture(t.TEXTURE_CUBE_MAP,r),t.texImage2D(i[s],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,h),a()},h.onerror=()=>o(new Error(`加载立方体贴图失败: ${e}`)),h.src=e}))));return await Promise.all(s),this.texture=r,!0}catch(e){return console.error(e),!1}}bind(e=0){if(this.texture){const t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.texture)}}bindAsCubemap(e=0){if(this.texture){const t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_CUBE_MAP,this.texture)}}getTexture(){return this.texture}getWidth(){return this.width}getHeight(){return this.height}}class r{constructor(e){this.framebuffer=null,this.colorTexture=null,this.depthRenderbuffer=null,this.width=0,this.height=0,this.gl=e}create(e){const r=this.gl;this.width=e.width,this.height=e.height;const i=r.createFramebuffer();if(!i)return console.error("创建帧缓冲失败"),!1;r.bindFramebuffer(r.FRAMEBUFFER,i);let s=e.colorTexture;if(!s){const i=new t(r);if(!i.createEmptyTexture(e.width,e.height))return r.bindFramebuffer(r.FRAMEBUFFER,null),!1;if(s=i.getTexture(),!s)return r.bindFramebuffer(r.FRAMEBUFFER,null),!1}if(r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,s,0),this.colorTexture=s,e.createDepthBuffer){const t=r.createRenderbuffer();if(!t)return console.error("创建深度渲染缓冲失败"),r.bindFramebuffer(r.FRAMEBUFFER,null),!1;r.bindRenderbuffer(r.RENDERBUFFER,t),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,e.width,e.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,t),this.depthRenderbuffer=t}const a=r.checkFramebufferStatus(r.FRAMEBUFFER);return a!==r.FRAMEBUFFER_COMPLETE?(console.error("帧缓冲不完整:",a),r.bindFramebuffer(r.FRAMEBUFFER,null),!1):(r.bindFramebuffer(r.FRAMEBUFFER,null),this.framebuffer=i,!0)}bind(){if(this.framebuffer){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.viewport(0,0,this.width,this.height)}}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}getColorTexture(){return this.colorTexture}getWidth(){return this.width}getHeight(){return this.height}cleanup(){const e=this.gl;this.depthRenderbuffer&&(e.deleteRenderbuffer(this.depthRenderbuffer),this.depthRenderbuffer=null),this.framebuffer&&(e.deleteFramebuffer(this.framebuffer),this.framebuffer=null)}}class i{constructor(e){this.gl=null,this.quadVAO=null,this.mouseX=0,this.mouseY=0,this.paused=!1,this.resizeObserver=null,this.animationFrameId=0,this.startTime=0,this.blackHoleShader=null,this.passthroughShader=null,this.galaxyTexture=null,this.colorMapTexture=null,this.blackHoleTexture=null,this.blackHoleFBO=null,this.config={gravatationalLensing:!0,renderBlackHole:!0,mouseControl:!0,cameraRoll:0,frontView:!1,topView:!1,adiskEnabled:!0,adiskParticle:!0,adiskDensityV:2,adiskDensityH:4,adiskHeight:.55,adiskLit:.25,adiskNoiseLOD:5,adiskNoiseScale:.8,adiskSpeed:.5},this.canvas=e}async init(){try{if(this.gl=this.canvas.getContext("webgl"),!this.gl)throw new Error("无法创建WebGL上下文");return this.createQuadBuffer(),await this.initShaders(),await this.loadTextures(),this.createFramebuffers(),this.setupMouseEvents(),this.setupResizeObserver(),this.startTime=performance.now(),!0}catch(e){return console.error("初始化失败:",e),!1}}createQuadBuffer(){const e=this.gl;if(!e)return;const t=new Float32Array([-1,-1,0,-1,1,0,1,1,0,1,1,0,1,-1,0,-1,-1,0]),r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,null)}async initShaders(){const t=this.gl;t&&(this.blackHoleShader=new e(t),await this.blackHoleShader.load("shader/simple.vert","shader/blackhole_main.frag"),this.passthroughShader=new e(t),await this.passthroughShader.load("shader/simple.vert","shader/passthrough.frag"))}async loadTextures(){const e=this.gl;e&&(this.galaxyTexture=new t(e),await this.galaxyTexture.loadCubemap(["assets/skybox_nebula_dark/right.png","assets/skybox_nebula_dark/left.png","assets/skybox_nebula_dark/top.png","assets/skybox_nebula_dark/bottom.png","assets/skybox_nebula_dark/front.png","assets/skybox_nebula_dark/back.png"]),this.colorMapTexture=new t(e),await this.colorMapTexture.loadFromUrl("assets/color_map.png"),this.blackHoleTexture=new t(e),this.blackHoleTexture.createEmptyTexture(this.canvas.width,this.canvas.height))}createFramebuffers(){const e=this.gl;if(!e||!this.blackHoleTexture)return;this.blackHoleFBO=new r(e);const t={width:this.canvas.width,height:this.canvas.height,colorTexture:this.blackHoleTexture.getTexture()||void 0};this.blackHoleFBO.create(t)}setupMouseEvents(){this.canvas.addEventListener("mousemove",(e=>{this.mouseX=e.clientX,this.mouseY=e.clientY})),window.addEventListener("keydown",(e=>{"Space"===e.code&&(this.paused=!this.paused,this.paused?cancelAnimationFrame(this.animationFrameId):this.start())}))}setupResizeObserver(){this.resizeObserver=new ResizeObserver((()=>{this.handleResize()})),this.resizeObserver.observe(this.canvas),this.handleResize()}handleResize(){const e=this.gl;if(!e)return;const t=window.devicePixelRatio||1,r=this.canvas.clientWidth,i=this.canvas.clientHeight;if((this.canvas.width!==r*t||this.canvas.height!==i*t)&&(this.canvas.width=r*t,this.canvas.height=i*t,this.blackHoleTexture&&this.blackHoleTexture.createEmptyTexture(this.canvas.width,this.canvas.height),this.blackHoleFBO&&this.blackHoleTexture)){const e={width:this.canvas.width,height:this.canvas.height,colorTexture:this.blackHoleTexture.getTexture()||void 0};this.blackHoleFBO.create(e)}e.viewport(0,0,this.canvas.width,this.canvas.height)}start(){this.paused||(this.render(),this.animationFrameId=requestAnimationFrame((()=>this.start())))}render(){const e=this.gl;if(!(e&&this.blackHoleShader&&this.passthroughShader&&this.galaxyTexture&&this.colorMapTexture&&this.blackHoleFBO))return;const t=(performance.now()-this.startTime)/1e3;this.blackHoleFBO.bind(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT),this.blackHoleShader.use(),this.blackHoleShader.setUniform2f("resolution",this.canvas.width,this.canvas.height),this.blackHoleShader.setUniform1f("time",t),this.blackHoleShader.setUniform1f("mouseX",this.mouseX),this.blackHoleShader.setUniform1f("mouseY",this.mouseY),this.blackHoleShader.setUniform1f("gravatationalLensing",this.config.gravatationalLensing?1:0),this.blackHoleShader.setUniform1f("renderBlackHole",this.config.renderBlackHole?1:0),this.blackHoleShader.setUniform1f("mouseControl",this.config.mouseControl?1:0),this.blackHoleShader.setUniform1f("cameraRoll",this.config.cameraRoll),this.blackHoleShader.setUniform1f("frontView",this.config.frontView?1:0),this.blackHoleShader.setUniform1f("topView",this.config.topView?1:0),this.blackHoleShader.setUniform1f("adiskEnabled",this.config.adiskEnabled?1:0),this.blackHoleShader.setUniform1f("adiskParticle",this.config.adiskParticle?1:0),this.blackHoleShader.setUniform1f("adiskDensityV",this.config.adiskDensityV),this.blackHoleShader.setUniform1f("adiskDensityH",this.config.adiskDensityH),this.blackHoleShader.setUniform1f("adiskHeight",this.config.adiskHeight),this.blackHoleShader.setUniform1f("adiskLit",this.config.adiskLit),this.blackHoleShader.setUniform1f("adiskNoiseLOD",this.config.adiskNoiseLOD),this.blackHoleShader.setUniform1f("adiskNoiseScale",this.config.adiskNoiseScale),this.blackHoleShader.setUniform1f("adiskSpeed",this.config.adiskSpeed),this.blackHoleShader.setUniform1f("fovScale",1),this.galaxyTexture.bindAsCubemap(0),this.blackHoleShader.setUniform1i("galaxy",0),this.colorMapTexture.bind(1),this.blackHoleShader.setUniform1i("colorMap",1),e.drawArrays(e.TRIANGLES,0,6),this.blackHoleFBO.unbind(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT),this.passthroughShader.use(),this.passthroughShader.setUniform2f("resolution",this.canvas.width,this.canvas.height);const r=this.blackHoleFBO.getColorTexture();r&&(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r),this.passthroughShader.setUniform1i("texture0",0)),e.drawArrays(e.TRIANGLES,0,6)}cleanup(){cancelAnimationFrame(this.animationFrameId),this.resizeObserver&&this.resizeObserver.disconnect(),this.blackHoleFBO&&this.blackHoleFBO.cleanup()}}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("canvas");if(!e)return void console.error("Canvas元素未找到");const t=new i(e);t.init(),t.start()}))})();